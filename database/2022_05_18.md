# 트랜젝션(Transaction)

## 트랜젝션
- 데이터베이스에서 상태를 변경시키기 위해 수행하는 작업 단위
- 트랜젝션은 상황에 따라 여러 개가 만들어질 수 있다.
- 트랜젝션은 commit 전에 언제든지 수동으로 Rollback 될 수 있다.

## 트랜젝션 4대 특징
- 원자성 : 트랜젝션이 DB에 모두 반영되거나, 모두 반영되지 않는 것을 뜻한다.
- 일관성 : 트랜젝션 작업 처리의 결과가 항상 일관되어야 한다.
- 독립성 : 하나의 트랜젝션은 다른 트랜젝션에 끼어들 수 없고 독립적이다.
- 지속성 : 트랜젝션이 성공적으로 완료되면 데이터 변경 사항이 영구적으로 확정되도록 보장

## 트랜젝션 격리 수준
- Read Uncommitted : 아직 commit 되지 않은 데이터를 다른 트랜젝션이 읽는 것을 허용
- Read Committed : 트랜젝션이 commit 확정된 데이터만 다른 트랜젝션이 읽도록 허용
- Repeatable Read : 쿼리를 두 번 이상 수행할 때, 첫 번째 쿼리에 있던 레코드가 사라지거나 값이 바뀌는 현상을 방지
- Serializable : 직렬화 가능 쿼리를 두 번 이상 수행할 때, 첫 번째 쿼리에 있던 레코드가 사라지거나 값이 바뀌지 않음은 물론 새로운 레코드가 나타나지도 않음  
(가장 이상적인 격리 수준의 보장, DBMS 운영 시 동시성이 크게 떨어지면서 성능 상 이슈 발생)

## 격리 수준에 따라 발생하는 문제점
- Dirty Read : 어떠한 트랜젝션에서 처리한 작업이 완료되지 않았음에도 다른 트랜젝션에서 볼 수 있게 되는 현상  
허용 격리 수준 : Read Uncommitted 
- Non-repeatable Read : 동일한 SELECT 쿼리를 실행했을 때 항상 같은 결과를 보장해야한다는 "Repeatable Read" 정합성에 어긋나는 현상  
허용 격리 수준 : Read Uncommitted, Read Committed 
- Phantom Read : 한 트랜젝션 내에서 동일한 쿼리를 두 번 수행했는데, 첫 번째 쿼리에서 없던 유령 레코드가 두번째 쿼리에서 나타나는 현상  
허용 격리 수준 : Read Uncommitted, Read Committed, Repeatable Read

***

# 트랜젝션의 락과 데드락

## 락의 개념
- 데이터의 무결성을 보장하기 위한 방법 중 한가지
- 락은 둘 혹은 그 이상의 사용자가 같은 시간에 같은 데이터를 업데이트하는 것을 방지하기 위해 존재
- 락이 걸린 데이터는 락이 풀릴 때까지 다른 사용자가 조작할 수 없다. 락은 commit이나 rollback 구문 이후에 풀리게 된다.

## 락의 종류
- 공유 Lock : 데이터를 읽을 때 사용하는 Lock, Select할 때 주로 사용, 한 프로세스가 보고 있는 데이터를 다른 프로세스가 볼 수 있지만 변경은 불가하다.

- 베타 Lock : 데이터를 변경할 때 사용하는 Lock, Insert, Update, Delete 할 때 주로 사용, 락이 헤제되기 전에는 다른 락을 설정할 수 없다. (읽기와 쓰기 불가)

- 락 사용 규칙
    - 다른 트랜젝션이 데이터에 공유락을 걸어둔 경우, 공유락 요청은 허용하고 베타락은 허용하지 않는다.
    - 다른 트랜젝션이 데이터에 베타락을 걸어둔 경우, 공유락 베타락 둘 다 허용하지 않는다.

## 데드락(교착상태)의 개념
- 두 개 이상의 트랜젝션이 각각 자신의 데이터에 대하여 락을 획득하고 상대방의 데이터에 대하여 락을 요청하면 무한 대기 상태에 빠질 수 있는 현상  
(시스템 자원에 대한 요구가 뒤엉킨 상태)
- 데드락이 발생하면 DBMS는 충돌한 작업 중 하나를 강제로 중지

## 데드락의 발생 조건
- 상호 배제 : 한 번에 프로세스 하나만 헤당 자원을 사용할 수 있다.
- 점유 대기 : 자원을 최소한 하나 보유, 다른 프로세스에 할당된 자원을 점유하기 위해 대기하는 프로세스 조내
- 비선점 : 이미 할당된 자원을 강제로 빼앗을 수 없다.
- 순환 대기 : 대기 프로세스의 집합이 순환 형태로 자원을 대기하고 있어야 한다.

## 데드락 최소화 대책
- 트랜젝션을 자주 커밋
- 정해진 순서로 테이블에 엑세스하게 함
- 필요 없는 셩우에는 읽기 잠금 획득 사용을 피함
-  쿼리에 의한 잠금 범위 좁히거나 더 작은 것으로 함
- 테이블 단위 잠금 획득해 갱신 직렬화

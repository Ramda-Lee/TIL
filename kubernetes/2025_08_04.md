# 쿠버네티스

## Rolling Updates and Rollbacks

### Deployment와 Rollout
- Deployment를 생성하면 Rollout이 자동으로 트리거됨
- 각 Rollout은 새로운 Recision을 생성함 (예: 최소 배포는 revision 1, 이후 업데이트 시 revision 2)
- 관련 명령어
  ```
    kubectl rollout status <deployment명>: 현재 롤아웃 상태 확인
    kubectl rollout history <deployment명>: 롤아웃 히스토리 및 리비전 목록 확인
  ```

### 배포전략
#### Recreate 전략
- 기존 인스턴스를 모두 종료 후 새로운 버전을 생성
- 단점: 일시적으로 서비스 중단

#### RollingUpdate 전략(기본값)
- 기존 인스턴스를 하나씩 종료하고 새로운 버전으로 순차 교체
- 장점: 무중단 배포 가능

#### 전략 확인 명령어
```
  kubectl describe deployment <deployment명> # 이벤트 로그에서 전략 방식 확인 가능
```

### 배포 업데이트 방법
#### yaml파일을 통한 적용
-  배포 파일 수정 후 적용
```
  kubectl apply -f deployment.yaml
```

#### 명령어로 이미지 업데이트
```
  kubectl set image deployment/<deployment명> <컨테이너명>=<이미지>:<태크>
```
- 주의: 이 방법은 yaml파일과 실제 상태가 불일치할 수 있다.

### 업그레이드 내부 동작 방식
- 배포 시 kubernetes는 ReplicaSet을 생성하고, 이 ReplicaSet이 Pod를 관리
- 새 버전 배포 시:
  - 새로운 ReplicaSet 생성
  - 가존 ReplicaSet Pod는 하나씩 종료
  - 새로운 ReplicaSet Pod는 하나씩 시작
- 확인 명령어
```
  kubectl get replicasets
```

### Rollback
- 문제 발생 시 이전 revision으로 간편하게 복구 가능
- 롤백 명령어
```
  kubectl rollout nudo deploymnet/<deployment명>
```
- 롤백 후 ReplicaSet 상태
  - 이전 ReplicaSet: 5 Pod
  - 현재(문제 있는) ReplicaSet: 0 Pod

### 주요 명령어 정리
## 📌 주요 명령어 요약

| 목적               | 명령어 예시                                      |
|--------------------|--------------------------------------------------|
| 배포 생성           | `kubectl create -f deployment.yaml`             |
| 배포 목록 확인       | `kubectl get deployments`                       |
| 배포 적용 (업데이트) | `kubectl apply -f deployment.yaml`              |
| 이미지 업데이트      | `kubectl set image deployment/<배포명> <컨테이너명>=<이미지>:<태그>` |
| 롤아웃 상태 확인     | `kubectl rollout status <deployment>`           |
| 롤백 수행           | `kubectl rollout undo deployment/<deployment>`  |
| ReplicaSet 확인     | `kubectl get replicasets`                       |
| 배포 상세 보기       | `kubectl describe deployment <deployment>`      |
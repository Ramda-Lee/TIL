# 쿠버네티스

## View Certificate Details (Cluster Health check)

### Cluster 파악하기
- kubernetes 클러스터는 여러 방식으로 배포될 수 있으며, 각 방식은 인증서를 생성하고 관리하는 방법이 다르다.
  - 수동 구축(The Hard Way): 관리자가 직접 인증서를 생성 및 설정
  - kubeadm 사용: kubeadm이 클러스터를 자동으로 설치하여 필요한 인증서를 자동으로 생성 및 구성함
  - kubectl 방식: 컴포넌트를 Pod로 배포하여 관리

### 인증서 목록 만들기
- 클러스터 내 모든 인증서를 조사하여 아래의 항목들을 정리한다  

| 항목 | 설명 |
|-----|-----------------------|
|인증서 파일명|실제 파일명|
|파일 경로|인증서 파일의 절대 경로|
|이름(Subject CN)|인증서에 설정된 이름|
|대체 이름(SAN)|추가 도메인/호스트 명|
|조직|소속 조직명|
|발급자(Issuer)|인증서를 발급한 CA|
|만료일|인증서 만료일자|

- Sampl Excel 자료 참고

### kubeadm 환경에서 인증서 찾기
- kubeadm으로 설치된 환경에서는 /etc/kubenetes/manifests/kube-apiserver.yaml 폴더 내의 API 서버 정의 파일을 확인한다
- 이 파일 내 --tls-cert-file 등의 옵션에서 API 서버가 사용하는 인증서 경로를 확인힐 수 있다.

### OpenSSL을 이용해 인증서 세부 정보 확인하기
- 예시: API 서버 인증서 확인
```
  openssl x509 -in /etc/kubernetes/pki/apiserver.cert -text -noout
```
- 확인해야 할 주요 정보
  - Subject: 인증서 이름 (CN=kube-apiserver)
  - Subject Alternetive Names(SANs): API 서버 접근 시 필요한 모든 도메인/IP가 포함되어 있는지 확인
  - Validity: Not Before, Not After -> 만료일 확인
  - Issuer: 발급자 (예: Kubernetes CA)

### 다른 인증서들도 확인 작업
- controller-manager
- scheduler
- etcd
- kubelet
- admin client 등

### 점검 시 주의할 점
- CN(이름)과 SAN(대체 이름)이 올바른지 확인
- 조직(O)이 올바른지 확인
- 올바른 CA(issuer)가 발급했는지 확인
- 만료되지 않았는지 반드시 확인

### 문제 발생 시 로그 확인
- 수동 구축 클러스터: 시스템 서비스로 실행되므로, OS 로그에서 확인
```
  journalctl -u kube-apiserver
```
- kubeadm 클러스터: 각 컴포넌트가 Pod로 실행됨 -> kubectl logs 사용
```
  kubectl logs -n kube-system kube-apiserver-master
```
- 만약 핵심 컴포넌트가(API server, etcd 등)가 죽어있으면 kubectl 명령이 작동하지 않는다. -> Docker 또는 containerd 수준에서 직접 로그 확인
```
  crictl ps -a
  crictl logs <container-id>
```
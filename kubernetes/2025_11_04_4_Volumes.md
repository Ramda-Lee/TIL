# 쿠버네티스

## Volumes

### 개요: 파드 데이터의 지속성

파드가 생성한 데이터는 볼륨에 저장되며, 파드를 삭제한 뒤에도 데이터는 남는다.

간단한 구현을 통해 살펴보자. 단일 노드 Kubernetes 클러스터에서, 1~100 사이의 난수를 생성해 `/opt/out` 파일에 기록하는 간단한 파드를 만든다. 파드가 삭제되면 해당 난수도 함께 사라진다.

이를 보존하기 위해 볼륨을 생성한다. (볼륨에는 저장소(storage) 가 필요하다.)

---

### 볼륨 생성과 마운트 (단일 노드, hostPath 예시)

볼륨을 만들 때 저장소는 여러 방식으로 구성할 수 있다. 여기서는 간단히 호스트의 디렉터리를 사용한다. 예를 들어 호스트의 경로 `/data` 를 지정한다. 이렇게 하면 볼륨에서 생성된 파일은 노드의 `/data` 디렉터리에 저장된다.

이제 컨테이너에서 접근할 수 있도록, 컨테이너 내부 디렉터리에 볼륨을 마운트한다. 각 컨테이너의 `volumeMounts` 필드를 사용해 `/opt` 에 마운트한다. 그러면 난수는 컨테이너 내부의 `/opt`(볼륨 마운트 지점) 으로 기록되고, 이는 실제로 호스트의 `/data` 디렉터리에 해당한다.

> 파드가 삭제되어도, 난수가 담긴 파일은 호스트에 그대로 남는다.

---

### 저장소 옵션 살펴보기

앞서 우리는 hostPath 옵션으로 호스트 디렉터리를 볼륨 저장소로 사용했다. 이는 단일 노드에서는 잘 동작하지만, 멀티 노드 클러스터에서는 권장되지 않는다.

- 멀티 노드에서 파드는 모든 노드의 `/data` 디렉터리를 사용할 수 있고, 이들이 모두 동일한 데이터를 가진다고 가정하게 된다.
- 그러나 노드들은 서로 다른 서버이므로 실제로는 동일하지 않다.
- 외부 복제 클러스터 스토리지 같은 별도의 해법을 구성하지 않는 한, 데이터 일관성이 보장되지 않는다.

Kubernetes는 다양한 스토리지 솔루션을 지원한다. 예:

- NFS 클러스터 / NFS
- Flocker
- Fibre Channel
- CephFS
- ScaleIO
- 퍼블릭 클라우드: AWS EBS, Azure Disk/File, Google Persistent Disk

예를 들어, 저장소 옵션으로 AWS Elastic Block Store(EBS) 를 사용하려면, 볼륨의 `hostPath` 필드를 `awsElasticBlockStore` 필드로 바꾸고 `volumeID`, 파일시스템 타입 등을 지정한다. 그러면 볼륨 저장소는 AWS EBS 위에 위치하게 된다.
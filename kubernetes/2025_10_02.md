# 쿠버네티스

## Certificates API

### 기본 개념
- Kubernetes 클러스터는 각 구성 요소(API server, Controller, etcd 등)가 통신할 때 CA가 서명한 인증서를 사용함
- 관리자는 클러스터 초기 설정 시 CA 서버를 만들고, 그로부터 여러 구성요소용 인증서를 발급함
- CA 서버는 루트 인증서(ca.crt)와 개인 키(ca.key) 두 파일로 구성되며, 이 두 파일이 있으면 누구나 새 사용자 인증서를 만들 수 있으므로 반드시 안전하게 보관해야 한다.

### 새로운 관리자 추가 절차
1. 새 관리자가 자신의 개인 키 생성
2. 그 키로 CSR(Certificate Signing Request) 생성
3. 기존 관리자에게 CSR 전달
4. 관리자가 CA 서버의 루트 인증서와 개인 키로 서명 -> 새 인증서 발급
5. 발급된 인증서를 새 관리자에게 전달 (인증서는 유효기간이 있어 만료될 때마다 CSR 재생성과 서명 과정을 반복해야 한다.)

### kubeadm의 CA 구조
- kubeadm으로 설치한 클러스터에서는 마스터 노드에 CA 파일이 자동 생성 및 저장됨
- 별도의 외부 CA 서버가 아니라 마스터 노드가 곧 CA 서버 역할을 한다.

### Certificates API (자동화)
- 수동으로 CA 서버에 로그인하지 않아도, kubernetes 내에서 CSR을 객체로 관리하고 승인할 수 있는 API
- 동작 순서
  1. 사용자가 CSR을 생성하고 base64 인코딩
  2. 관리자가 아래와 같은 YAML을 작성해 CSR 오브젝트 생성
  ```
    apiVersion: certificates.k8s.io/v1
    kind: CertificateSigningRequest
    metadata:
      name: user1
    spec:
      request: <base63 CSR 내용>
  ```
  3. 관리자
  ``` 
    kubectl get csr # 요청 목록 확인
    kubectl certificate approve user1 # 승인
  ```
  4. Kubernetes가 CA 키로 서명하여 인증서 생성
  5. kubectl get csr user1 -o yaml로 확인 후 base64 디코딩하여 실제 인증서를 사용자에게 전달

### 컴포넌트 서명
- 인증서 관련 작업은 kube-controller-manager가 수행
- 내부에는 csr-approving, csr-signing 등의 컨트롤러가 존재하며, CA키(--cluster-signing-key-file)와 인증서(--cluster-signing-cert-file)를 사용해 서명 처리
# 쿠버네티스

## Pod Networking Concepts

### 문제 정의
노드 간 네트워크는 이미 구성되어 있지만, 실제 애플리케이션은 Pod 안에서 돌아간다. Kubernetes는 “Pod마다 고유 IP를 부여하고, 노드 내부/외부 어디서든 해당 IP로 통신 가능해야 하며, 이를 위해 NAT를 요구하지 않는다”는 요구사항만 제시하고 구현은 사용자가 맡는다.

### 노드별 브리지 네트워크 설계
1. 각 노드에 브리지 인터페이스 생성(`br0` 등) 후 고유 서브넷 할당  
   - 예: Node1 → 10.244.1.0/24, Node2 → 10.244.2.0/24, Node3 → 10.244.3.0/24
2. 브리지에 IP 지정 (`ip addr add 10.244.1.1/24 dev br0`)
3. 이후 생성되는 각 Pod(네트워크 네임스페이스)에 대해 veth 페어를 만들고 한쪽을 Pod에, 다른 한쪽을 브리지에 연결
4. Pod 인터페이스에 IP/게이트웨이 설정(`10.244.1.2`, GW `10.244.1.1`) 후 up

이렇게 하면 한 노드 내 Pod 간 통신이 가능하다.

### 노드 간 라우팅
서브넷이 다르므로 노드 라우팅 테이블에 서로의 Pod CIDR을 등록해야 한다.
- Node1에 `ip route add 10.244.2.0/24 via 192.168.1.12`
- Node2에 `ip route add 10.244.1.0/24 via 192.168.1.11`
… 이런 방식으로 모든 노드에 다른 노드의 Pod CIDR 경로를 추가한다. 더 규모가 크다면 라우터/게이트웨이에 통합 경로를 등록해 각 노드의 기본 게이트웨이가 라우팅하도록 만들 수 있다. 이렇게 하면 전체 Pod 네트워크를 10.244.0.0/16과 같은 하나의 대역으로 묶을 수 있다.

### 수작업에서 자동화로: 스크립트와 CNI
Pod가 만들어질 때마다 다음 작업을 수행해야 한다.
1. 네트워크 네임스페이스 생성(컨테이너 런타임이 담당)
2. veth 페어 생성 및 한쪽을 네임스페이스에 이동
3. 브리지에 연결
4. IP 할당, 라우트 추가, 인터페이스 up

이를 반복하기 위해 간단한 스크립트를 작성해 `ADD` 시 위 작업을 수행하고, `DEL` 시 인터페이스/라우트 정리와 IP 반환을 하도록 만든다. 하지만 Kubernetes는 직접 스크립트를 실행하지 않으므로 CNI 표준에 맞게 플러그인을 작성해야 한다.

### CNI와 Pod 네트워크
컨테이너 런타임(Kubelet이 호출) → CNI 플러그인(`bridge`, `flannel`, `calico` 등) → 위 과정을 자동 처리  
CNI 구성 파일에는 각 노드의 Pod CIDR, 브리지 이름, IPAM 방식 등이 정의된다. Pod 생성 시 런타임이 `ADD` 요청을 보내면 플러그인이 veth 연결/브리지 조인/IP 할당/라우팅을 수행한다.

### 요약
- Pod 네트워크는 노드 네트워크 위에 추가되는 가상 네트워크 계층
- Pod마다 고유 IP를 부여하고 노드 간 라우팅을 구성해야 함
- 수동 구성은 브리지+veth+라우트 조합으로 가능하지만, 실제 운영에서는 CNI 플러그인이 동일 작업을 자동화한다
# 쿠버네티스

## Cluster Upgrade Process

### Version Skew 규칙
- kube-apiserver
  - 제어 플레인의 중심. 모든 컴포넌트가 apiserver와 통신
  - 다른 컴포넌트가 apiserver보다 높은 버전이면 안됨
  - 기준 버전을 x라고 할 때: apiserver = x
- controller-manager / scheduler
  - apiserver보다 같거나 한 단계 낮은 버전 가능
  - 예: apiserver=1.10 -> controller-manager=1.10 or 1.9
- kubelet / kube-proxy
  - apiserver보다 같거나 두 단계 낮은 버전 가능
  - 예: apiserver=1.10 -> kubelet=1.10 or 1.9, 1.8
- kubectl (CLI)
  - 예외적으로 +1, 0, -1 버전 모두 허용
  - 예: apiserver=1.10 -> kubectl=1.11, 1.10, 1.9

### 지원 버전 정책
- kubernetes는 항상 최근 3개의 마이너 버전만 공식 지원
- 예시:
  - 최신이 1.12 -> 지원: 1.12, 1.11, 1.10
  - 1.13 출시 시 -> 지원: 1.13, 1.12, 1.11 (1.10은 더 이상 지원 않음)
- 새 버전 릴리스 전에 업그레이드 준비 필요

### 업그레이드 원칙
- 마이너 버전은 반드시 단계별 업그레이드
  - 1.10 -> 1.13 직접 업그레이드 불가
  - 1.10 -> 1.11 -> 1.12 -> 1.13 순서로 진행
- 업그레이드 순서:
  1. 마스터 노드 먼저 업그레이드
  2. 이후 워커 노드 업그레이드

### 마스터 노드 업그레이드 과정
- 업그레이드 중:
  - API server, scheduler, controller-manager가 일시 중단
  - kubectl 및 관리 기능 사용 불가 (배포, 수정, 삭제 불가)
  - Pod 자가 복구 불가 (컨트롤러 정지)
- 워커 노드와 기존 Pod는 정상 서비스 유지
- 사용자 서비스 영향 없음 (단, 관리 기능만 잠시 멈춤)
- 업그레이드 완료 후 정상 복구

### 워커 노드 업그레이드 전략
- 모든 노드 동시 업그레이드
  - 장점: 빠름
  - 단점: Pod 다운 -> 사용자 서비스 중단
- 노드별 순차 업그레이드 (권장)
  - 한 노드씩 drain -> 업그레이드 -> uncordon
  - 워크로드가 다른 노드로 자동 이동
  - 무중단 업그레이드 가능
- 신규 노드 추가 후 교체
  - 클라우드 환경에서 적합
  - 최신 버전 노드 추가 -> 워크로드 이전 -> 구버전 노드 제거
  - 다운타임 최소화

### kubeadm을 활용한 업그레이드
#### 업그레이드 계획 확인
```
  kubeadm upgrade plan
```
- 현재 클러스터 버전, kubeadm 버전, 최신 안정 버전 표시
- 업그레이드 가능한 컨트롤 플레인 컴포넌트 버전 안내
- kubelet은 수동 업그레이드 필요하다는 점 안내

####  kubeadm 업그레이드
- 먼저 kubeadm 툴 자체를 최신 마이너 버전으로 올려야 함
```
  apt-get upgrade kuneadm
  kubeadm upgrade apply v1.12.0
```

#### 마스터 노드 kubelet 업그레이드
- kubeadm은 kubelet 자동 업그레이드 안됨 -> 직접 패키지 업그레이드
```
  apt-get upgrade kubelet
  systemctl restart kubelet
```

#### 워커 노드 업그레이드
- 노드 drain
```
  kubectl drain node-1 --ignore-daemonsets
```
- kubeadm/kubelet 업그레이드 + kubelet 재시작
- 노드 uncordon:
```
  kubectl uncordon node-1
```
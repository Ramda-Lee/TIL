# 쿠버네티스

## Backup and Restore Methods

### Backup 할 대상
- etcd 클러스터: 클러스터 상태 및 리소스 정보 저장소
- Persistent Storage: 애플리케이션 데이터 저장 시 백업 필요
- 리소스 정의 파일: Deployment, Pod, Service 등 선언형 구성 파일

### 리소스 생성 방식과 Backup
- 명령형(Imperative)
  - kubectl create, kubectl expose 등 직접 명령 실행
  - 기록 누락 시 복원 어려움
- 선언형(Declarative) (권장)
  - Yaml 정의 파일 작성 후 kubecrtl apply
  - 구성 파일을 Github 같은 저장소에 보관 -> 협업 & backup 용이

### API 서버 기반 Backup
- kubectl 또는 API 서버 직접 질의 -> 리소스 Yaml 추출
- 예시:
```
  kubectl get all --all-namespaces -o yaml > backup.yaml
```
- 장점: 클러스터 전체 리소스 구성을 보존
- 단점: 리소스가 많으면 관리 복잡
- 도구: Velero(구 Ark)
  - kubernetes API 활용 자동화 Backup/복원

### etcd 기반 백업
- 데이터 디렉토리 자체 백업 가능
- etcd 내장 스냅샷 기능 활용
```
  ETCDCTL_API=3 etcdctl snapshot save snapshot.db
  ETCDCTL_API=3 etcdctl snapshot status snapshot.db
```

### 복원 절차
1. Kube API 서버 중지
2. 스냅샷 복원
```
  ETCDCTL_API=3 etcdctl snapshot restore snapshot.db
```
  - 새로운 클러스터 구성 생성
3. etcd 설정 파일에서 새로운 데이터 디렉토리 지정
4. 서비스 재시작
```
  systemctl daemon-reload
  systemctl restart etcd
  systemctl restart kube-apiserver
```
5. 인증서 지정 필요 (CA cert, etcd server cert, key)

### 두 가지 접근법 비교
| 방법 | 특징 | 장점 | 단점 | 적합한 환경 |
|-----|-----|-----|-----|----------|
|API 서버 백업|리소스 정의를 Yaml로 추출|관리형 K8s에서도 가능, 간단|모든 상태가 100% 동일하지 않을 수도 있음| 클라우드, 관리형 Kubernetes|
|etcd 백업|etcd 스냅샷 사용|클러스터 전체 상태 보존|etcd 접근 권한 필요|자체 구축 클러스터(온프렘)|

## etcdctl & etcdutl 사용하기
- etcdctl: etcd를 위한 커맨드라인 클라이언트
- Kubernetes 실습 환경에서는 마스터 노드에 static pod 형태로 etcd가 배포됨
- 사용 버전: v3 (etcdctl version)

### etcd Backup
#### etcdctl 사용 (snapshot 기반 백업)
- 실행 중인 etcd 서버에서 스냅샷을 생성
```
  ETCDCTL_API=3 etcdctl 
    --endpoints=https://localhost:2379 \  
    --cacert=/etc/kubernetes/pki/etcd/ca.crt \
    --cart=/etc/kubernetes/pki/etcd/sercer.crt \
    --key=/etc/kubernetes/pki/etcd/server.key \
    snapshot save /backup/etcd-snapshot.db
```
- 필수 옵션
  - --endpoints: etcd 서버 주고 (기본값: localhost:2379)
  - --cacert: CA 인증서 경로
  - --cert: 클라이언트 인증서 경로
  - --key: 클라이언트 키 경로

#### etcdutl 사용 (파일 백업 기반)
- 오프라인 상태에서 데이터 디렉토리 전체를 백업
```
  etcdutl backup \
    --data-dir /var/lib/etcd \
    --backup-dir /backup/etcd-backup
```
-> etcd 백엔드 DB 및 WAL 파일을 지정한 디렉토리로 복사

#### Snapshot 상태 확인
- 스냅샷 파일의 메타데이터 확인
```
  etcdctl snapshot status /backup/etcd-snapshot.db \
    --write-out=table
```
- 출력내용
  - 파일 크기
  - 리비전
  - 해시 값
  - 전체 키 개수

### etcd 복원
#### Snapshot 복원 (etcdutl)
```
  etcdutl snapshot restore /backup/etcd-snapshot.db \
    --data-dir /var/lib/etcd-restored
```

#### 파일 백업 복원
- etcdutl backup으로 만든 백업은, 단순히 /var/lib/etcd 경로에 다시 복사 후 etcd 재시작

### 명령어 역할 정리
| 명령어 | 역할 |
|-------|-----|
| etcdctl snapshot save | 실행 중인 etcd 클러스터에서 .db 스냅샷 생성 |
| etcdctl snapshot status | 스냅샷 파일의 메타데이터 확인 (크기, revision, 해시 등) |
| etcdutl snapshot restore | .db 스냅샷 파일을 새 데이터 디렉토리로 복원 |
| etcdutl backup | etcd의 데이터와 WAL 파일을 파일 단위로 복사 (etcd 실행 불필요) |
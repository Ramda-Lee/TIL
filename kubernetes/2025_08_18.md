# 쿠버네티스

## Kubernetes Encrypting Secret Data at Rest

### Secret 생성과 Base64 인코딩 확인
- Secret은 기본적으로 Base64로 인코딩된 값으로 저장된다. 단순 인코딩이지 암호화가 아니다
```
  # Secret 생성
  kubectl create secret generic my-secret --from-literal=key1=supersecret

  # Secret 확인
  kubectl get secret my-secret -o yaml

  # Base64 디코딩
  echo "c3VwZXJzZWNyZXQ=" | base64 --decode # 디코딩 결과: supersecret
```
- Secret Yaml 파일을 github 등에 올리면 누구나 쉽게 디코딩 가능 -> 보안 주의

### etcd에 저장된 데이터 확인
- Secret은 etcd에 평문으로 저장된다.
```
  ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/Server.crt --key=/etc/kubernetes/pki/etcd/server.key get /registry/secrets/default/my-secret | hexdump -C
```
- Secret 값이 그대로 노출 -> etcd 접근 권한이 있으면 민감한 정보를 모두 확인할 수 있는 위험이 존재

### 암호화 여부
- API 서버가 암호화를 지원하도록 설정되어 있는지 확인
  ```
    ps aux | grep kube-apiserver
  ```
- --encryotion-provider-config 옵션이 없으면 암호화 미적용 상태
- kubeadm 환경에서는 /etc/kubernetes/manifests/kube-apiserver.yaml에서 확인 가능

### 암호화 설정 파일 작성
- 암호화 방법을 정의한 enc.yaml을 생성
```
  apiVersion: apiserver.config.k8s.io/v1
  kind: EncryptionConfiguration
  resources:
    - resources:
        - secrets
      providers:
        - aescbc:         # AES-CBC 알고리즘
            keys:
              - name: key1
                secret: <32바이트 랜덤 키>
        - identity: {}.   # 마지막에 배치 (암호화 없음)
```
- 랜덤 키 생성
```
  head -c 32 /dev/urandom | base64
```
- providers의 첫 번째 항목이 암호화 방식으로 사용됨
- identity는 단순 저장(암호화 없음)의미

### API 서버에 적용
- 암호화 설정 파일을 API 서버에 적용
- /etc/jubernetes/enc/enc.yaml
- kube-apiserver.yaml 수정
```
  # 추가 옵션
  - --encryotion-provider-config=/etc/kubernetes/enc/enc.yaml

  # 볼륨 마운트 추가
  volumeMount:
    - mountPath: /etc/kubernetes/enc
      name: encryption-config
      readOnly: true

  volumes:
  - name: encryption-config
    hostPath:
      path: /etc/kubernetes/enc
      type: DirectoryOrCreate
```
- 번경 후 kube-apiserver 자동 재시작 -> 암호화 기능 활성화

### 암호화 적용 확인
- 암호화 적용 후 새 Secret을 생성하여 확인
```
  kubectl create secret generic my-secret-2 --from-literal=key2=topsecret

  # etcd에서 확인
  ETCDCTL_API=3 etcdctl ... get /registry/secrets/default/my-secret-2 | hexdump -C
```
- 평문이 아니라 암호화된 데이터 저장 확인

### 기존 Secret 재암호화
- 암호화 적용 전의 Secret은 여전히 평문으로 남아있다 -> 이를 암호화 하려면 강제로 업데이트 해야한다
```
  kubectl get secrets --all-namespaces -o json | kubectl replace -f -
```
- 명령어 실행하면 모든 Secret이 새 설정에 맞게 암호화된다.
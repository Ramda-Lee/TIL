# 쿠버네티스

## TLS in Kubernetes - Certificate Creation

### CA 인증서 생성
1. OpenSSL 명령어 openssl genrsa -out ca.key로 CA의 개인 키를 생성한다.
2. 그 다음 openssl req 명령을 사용해 CSR(Certificate Siging Request, 인증서 서명 요청서)를 만든다. CSR은 모든 정보가 들어 있지만 서명이 없는 인증서 초안 같은 것이다. 여기서 CN(Common Name) 필드에 컴포넌트 이름을 지정한다
3. 마지막으로 openssl x509 명령으로 CSR을 CA의 개인 키로 서명하여 루트 인증서를 생성한다. CA 자신이 직접 자기 서명을 하는 것이다.
4. 이제 CA는 자신의 개인 키와 루트 인증서를 가지게 되며, 이후 다른 모든 인증서는 이 CA의 키 쌍으로 서명된다.

### 클라이언트 인증서 생성
- admin 인증서
  - openssl genrsa로 admin 개인 키를 생성한다
  - openssl req로 CSR을 만드는데, 이때 CN 필드에 사용자 이름을 지정한다. 예: kube-admin (꼭 kube-admin일 필요는 없지만, 이 이름이 kubectl에서 표시되고 감사 로그 등에서 보이므로 의미 있는 이름을 넣는 것이 좋다.)
  - openssl x509를 실행해서 CA의 키와 인증서로 서명된 admin 인증서를 생성한다.
- 생성한 admin 인증서를 통해 클러스터에 접속할 수 있다. 인증서는 신분증, 키는 비밀번호와 같은 역할
- admin 사용자에게 관리자 권한을 주려면 CSR를 만들 때 OU(Organization Unit)필드에 system:masters 그룹을 지정해야 한다. kubernetes에서 이 그룹은 관리자 권한을 가진다.
- 동일한 방식으로 kube-scheduler, kube-controller-manager, kube-proxy 등의 클라이언트 인증서도 생성한다. (단, 이들은 시스템 컴포넌트이므로 CN 앞에 system: 접두사를 붙여야 한다.)

### 서버 인증서 생성

#### etcd 서버
- etcd는 서버 인증서와 키가 필요하다.
- 고가용성(HA) 환경에서는 노드 간 통신을 위해 추가로 peer 인증서를 생성해야 한다.
- 생성된 인증서는 etcd 실행 시 --cert-file, --key-file 옵션에 지정한다. 또한 CA 인증서도 필요하다

#### kube-apiserver
- kube-apiserver는 클러스터에서 가장 중요한 컴포넌트, 모든 요청이 API 서버를 거친다
- CN 필드는 Kube-apiserver로 지정
- 중요한 점은 여러 이름(aliases)로 불린다는 것. 예: kubernetes, kubernetes.default, kubernetes.default.svc, kubernetes.default.svc.cluster.local, 그리고 API 서버의 IP 주소.
- 따라서 인증서에는 SAN(Subject Alternative Names) 항목에 이 모든 이름을 넣어야 한다. 이를 위해 OpenSSL 설정 파일(openssl.cnf)을 작성해 alt_names 섹션에 DNS와 IP를 추가한다.
-	마지막으로 CA로 서명하여 API 서버 인증서를 만든다.
- 만든 인증서들은 kube-apiserver 실행 시 옵션으로 지정한다.
  - --tls-cert-file, --tls-private-key-file
  -	etcd와 통신하기 위한 클라이언트 인증서
  -	kubelet과 통신하기 위한 클라이언트 인증서
  -	항상 CA 인증서도 함께 지정해야 한다.

#### kubelet 서버
- 각 노드에서 실행되는 kubelet은 자체 HTTPS API 서버이므로, 각 노드별로 인증서가 필요하다. 예: node01, node02, node03
- kubelet 설정 파일에 CA, 키, 인증서를 지정한다.
- kubeletdl API 서버에 클라이언트로 접속할 때 사용할 인증서도 필요하다.
  - CN 형식은 systems:node:<노드이름>
  - 그룹은 반드시 systems:nodes에 속해야 API 서버가 노드를 신뢰하고 적절한 권한을 부여할 수 있다.

### kubeconfig와 CA 루트 인증서
- 각 컴포넌트가 서로를 검증하려면 CA 루트 인증서가 필요하다. 따라서 서버와 클라이언트 설정 시 항상 CA 인증서를 포함해야 한다.
- admin 인증서를 예로 들면, REST API 호출 시 직접 키/인증서/CA인증서를 옵션으로 넘길 수 있다. 그러나 일반적으로는 이 모든 정보를 kubeconfig 파일에 넣어 관리한다. kubeconfig에는 API 서버 주소, 사용자 인증서, CA 인증서 등의 정보가 담긴다.
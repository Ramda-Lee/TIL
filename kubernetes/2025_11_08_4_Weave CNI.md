# 쿠버네티스

## Weave CNI

### 왜 Weave인가
Pod 네트워크를 수동으로 구성하면 노드 라우팅 테이블 관리가 복잡해진다. Weave CNI는 각 노드에 에이전트를 배포해 전체 토폴로지를 공유하고, Pod 간 트래픽을 캡슐화/전달함으로써 대규모 클러스터에서도 간단하게 네트워크를 확장할 수 있게 한다.

### 동작 방식
1. 노드마다 Weave 에이전트(피어)가 실행된다. Kubernetes에서는 `DaemonSet`(예: `weave-net`)으로 배포된다.
2. 에이전트들은 서로 정보를 교환해 “어느 노드에 어떤 Pod IP가 있는지” 토폴로지를 유지한다.
3. Weave는 각 노드에 자체 브리지 인터페이스(일반적으로 `weave`)를 만들고, Pod 인터페이스를 여기에 붙인다.
4. Pod가 다른 노드의 Pod로 패킷을 보내면, 로컬 Weave 에이전트가 패킷을 가로채 Encapsulation(VxLAN 유사)으로 노드 간 터널을 만든다.
5. 목적지 노드에서 Weave 에이전트가 패킷을 복원하고 대상 Pod로 전달한다.

### 설치 방법
Weave Cloud 서비스 종료로 인해 예전 설치 링크(`https://cloud.weave.works/...`)는 더 이상 동작하지 않는다([공지](https://www.weave.works/blog/weave-cloud-end-of-service) 참고). 최신 설치 방법은 GitHub 릴리스에 게시된 매니페스트를 사용하는 것이다.

Kubernetes 제어 plane이 준비된 상태에서 아래처럼 단 한 번의 명령으로 설치할 수 있다.
```bash
kubectl apply -f https://github.com/weaveworks/weave/releases/download/v2.8.1/weave-daemonset-k8s.yaml
```
이 매니페스트는:
- `kube-system` 네임스페이스에 `weave-net` DaemonSet을 생성해 모든 노드에 Pod를 띄운다.
- 필요한 ClusterRole, ServiceAccount, ConfigMap 등을 함께 배포한다.

설치 세부 옵션과 최신 버전은 [공식 문서](https://www.weave.works/docs/net/latest/kubernetes/kube-addon/#-installation)와 [릴리스 페이지](https://github.com/weaveworks/weave/releases)에서 확인할 수 있다.

### 확인 및 트러블슈팅
- `kubectl -n kube-system get pods -l name=weave-net -o wide`로 노드별 Pod 상태 확인
- `kubectl -n kube-system logs daemonset/weave-net`으로 로그 조회
- `ip link show weave`, `ip addr show weave`를 통해 브리지와 할당된 Pod CIDR 확인

### 기타 특징
- Weave는 Pod에 여러 브리지(예: Docker `docker0`, Weave `weave`)가 동시에 있을 수 있음을 고려해 올바른 라우팅을 설정한다.
- 캡슐화된 패킷은 기본 네트워크 위를 그대로 지나가므로, 하위 네트워크 구성 변경 없이도 다중 노드를 연결할 수 있다.
- IP 관리, 암호화, NetworkPolicy 연계 등 고급 기능도 제공한다.

Weave 동작 방식을 이해해 두면 Calico, Flannel, Cilium 같은 다른 CNI 솔루션을 비교·선택할 때도 빠르게 감을 잡을 수 있다.

# 쿠버네티스

## API Groups

### Kubernetes API 개요
- kubernetes의 모든 조작은 kube-apiserver를 통해 수행된다.(kubectl 명령이나 REST API 직접 호출 모두 API 서버와 통신)
- 기본 포트는 6443
  - 예: /version -> 클러스터 버전 반환
  - 예: /api/v1/pods -> Pod 목록 반환

### API 그룹의 목적과 종류
- kubernetes API는 목적에 따라 여러 그룹으로 나뉜다.
  - version: 클러스터 버전 조회용
  - health: 클러스터 상태 점검용
  - metrics / logs: 모니터링, 외부 로그 시스템 연동용
- 이 중 클러스터 기능을 담당하는 API들이 중요한데, 이는 두 가지 상위 그룹으로 분류된다

#### Core Group
- kubernetes의 주요 리소스가 포함됨: namespace, pods, replicationcontrollers, events, endpoints, nodes, bindings, persistenvolumes, persistenvolumeclaims, configmaps, secrets, services 등.

#### Named Groups
- 더 체계적으로 구성된 API 그룹으로, 새로운 기능들은 앞으로 모두 이 그룹에 추가
- 예시 
  - apps (Deployment, ReplicaSets, StatefulSets)
  - extensions
  - networking.k8s.io (NetworkPolicies)
  - storage.k8s.io
  - authentication.k8s.io
  - certificates.k8s.io (CertificateSigningRequests) 등

### 리소스와 동작 (Verbs)
- 각 리소스는 수행 가능한 여러 동작(verds)을 가진다 (예: list, get, create, update, watch 등)
- 예를 들어 deployments 리소스에 대해
  - list deployments (목록 조회)
  - get deployment (단일 조회)
  - create deployment (생성)
  - delete deployment (삭제)
  - update deployment (수정)
  - watch deployment (변경 감시)

### Kubernetes API Reference에서 확인
- kubernetes API Reference 문서에서 각 객체의 API 그룹과 버전 확인 가능
- 문서 첫 부분에 group 정보가 표시됨
- v1은 Core group을 의미하며, apps/v1, networking/k8s.io/v1 등은 Named Group이다.

### 클러스터에서 API 그룹 직접 보기
- 클러스터의 kube-apiserver에 https://<master>:6443로 접속하면 지원되는 모든 API 그룹 목록을 볼 수 있다.
- 각 Named Group 아래에는 해당 그룹의 리소스 목록이 표시된다.

### 인증 없이 접근 시 제한
- 인증 없이 curl로 API에 접근하면, /version 같은 일부 API를 제외하고는 접근이 거부된다.
- curl 명령에서 인증서 파일을 직접 지정해야 한다.
```
  curl --cert admin.crt --key admin.key --cacert ca.crt https://<api-server>:6443/api/v1/pods
```

### 대안: kubectl proxy 사용
- 인증서를 명시하지 않고 API를 확인하려면 kubectl proxy 사용
```
  kubectl proxy
```
- 이 명령은 로컬에서 HTTP 프록시 서비스를 실행한다.
  - 기본 포트: 8001
  - kubeconfig 파일의 인증서 및 자격 증명을 자동으로 사용
- 이후 브라우저나 curl로 http://localhost:8001에 접근하면 모든 API 그룹과 리소스 목록을 볼 수 있다.
- 프록시는 요청을 받아 API 서버로 전달하며, 인증은 사용자의 kubeconfig 정보를 사용한다.

### kube-proxy vs kubectl proxy
- 두 이름이 비슷하지만 전혀 다른 역할을 한다

| 항목 | 설명 |
|----|------|
| kube-proxy | 클러스터 내 Pod <-> Service 간 네트워크 통신을 처리하는 시스템 컴포넌트 |
| kubectl proxy | 로컬에서 실행되는 HTTP 프록시로, 사용자의 kubeconfig 인증서를 이용해 API 서버 접근을 가능하게 한다 |



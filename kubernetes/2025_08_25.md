# 쿠버네티스

## Kubernetes Multi-Container Pods Design Pattern

### Multi-Container Pods Design Pattern
- Pod내에서 여러 개의 컨테이너가 함께 실행되도록 설계된 구조
- 상황에 따라 다양한 패턴이 있으며, 크게 Co-located, init, Sidecar 세 가지가 있다

### Co-located 컨테이너
- 가장 기본적인 형태의 멀티 컨테이너
- 단순히 하나의 파드 안에 두 개 이상의 컨테이너를 정의하여 실행
- 모든 컨테이너가 파드의 전체 라이프사이클 동안 힘께 실행됨
- 주로 서로 의존적인 두 서비스를 함께 실행할 때 사용 (예: 웹 서버 + 메인 앱)
- spec.containers 배열에 여러 컨테이너를 나란히 정의
- 특징 및 한계
  - 동시에 시작됨
  - 시작 순서 보장 불가
  - 특정 컨테이너가 먼저 실행되어야 하는 경우에는 적합하지 않음

### Init 컨테이너
- pod가 시작되기 전 초기화 작업을 수행하는 컨테이너
- 메인 어플리케이션이 실행되기 전에 필요한 환경을 준비
- 예시:
  - DB가 준비될 때까지 대기
  - 외부 API 상태 체크 후 메인 앱 실행
- spec.initContainers 항목을 별도로 정의하여 사용
- init 컨테이너는 작업이 끝나면 종료되고, 그 이후 메인 애플리케이션이 시작됨
- 여러 개의 이닛 컨테이너를 정의 가능 -> 순차적으로 실행됨
  - 1번 init 컨테이너 실행 후 종료 -> 2번 init 컨테이너 실행 후 종료 -> 메인 컨테이너 실행
- 특징
  - 시작 순서 제어 가능
  - 초기화 후 종료 -> 메인 앱이 깨끗한 환경에서 실행됨

### Sidecar 컨테이너
- init 컨테이너와 유사하게 먼저 시작되지만, 종료되지 않고 메인 앱과 함께 실행됨
- pod 라이프 사이클 동안 유지되며, 메인 앱과 함께 종료됨
- 용도
  - 로그 수집기(Log Shippper)
  - 모니터링 에이전트
  - 보안 프록시
- 특징
  - 메인 앱 시작 전에 실행됨
  - 메인 앱 종료 시 함께 종료됨
  - 시작 순서 보장 가능 (restartPolicy=Always 설정)
  - 메인 앱의 시작 로그부터 종료 로그까지 모두 수집 가능
- 예시
  - ElasticSearch + Kibana 스택
    - ElasticSearch: 로그 수집 및 저장
    - kibana: 로그 시각화 대시보드
    - Filebeat 사이드카 추가 -> 앱 실행 전부터 종료 후까지 로그 수집

### 패턴 비교 요약
| 패턴                  | 실행 시점              | 실행 지속 여부       | 시작 순서 제어 | 주요 사용 사례                                   |
|-----------------------|------------------------|----------------------|----------------|------------------------------------------------|
| **Co-located Containers** | 파드 시작과 동시에 실행 | 파드 라이프사이클 전체 | 불가능       | 단순히 함께 실행되어야 하는 서비스 (예: 웹 + 앱) |
| **Init Containers**       | 파드 시작 시 메인 앱 실행 전 | 작업 완료 후 종료 | 가능         | DB 준비 대기, API 상태 체크 등 초기화 작업       |
| **Sidecar Containers**    | 메인 앱 실행 전          | 파드 라이프사이클 전체 | 가능         | 로그 수집기, 모니터링, 보안 프록시               |
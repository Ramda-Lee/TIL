# 쿠버네티스

## Authorization

### 인증과 인가의 차이
- 인증(Authentication): "누가" 클러스터에 접근할 수 있는가
- 인가(Authorization): "접근한 후 무엇을 할 수 있는가", 허용된 행동의 범위를 정의하는 단계

### Authorization이 필요한 이유
- 관리자는 모든 오브젝트를 조회, 생성, 수정, 삭제할 수 있지만, 클러스터에는 곧 여러 사용자가 접근한다.
- 다양한 사용자에게 다른 수준의 권한이 필요하다.
- 예시
  - 개발자: 애플리케이션 배포 권한만 허용, 클러스터 설정은 제한
  - 외부 서비스 계정: 필요 최소한의 권한만 부여
  - 여러 팀이 공유하는 경우: 자신의 Namespace만 접근 가능

### Kubernetes의 주요 Authorization 방식
- 쿠버네티스는 여러 Authorization 메커니즘을 제공한다

| 인가 방식 | 설명 |
|---------|---------------|
| Node Authorizer | 노드(Kubelet) 내부 요청 전용 |
| ABAC(Atrribute-Based Access Control) | 속성 기반 접근 제어 |
| RBAC(Role-Based Access Control) | 역할 기반 접근 제어 (표준 방식) |
| Webhook Authorizer | 외부 정책 엔진(예: OPA)에 위임 |

### Node Authorizer
- kube-apiserver는 사용자 요청과 노드 요청(Kubeet)을 모두 받는다
- Kubelet은 Pod, Node, Service 정보 조회 및 노드 상태 보고를 수행
- 이때 Node Authorizer는 system:nodes 그룹에 속하고 이름이 system:node: 로 시작하는 클라이언트를 인식해 필요한 권한만 부여한다.
- Node Authorizer는 노드 간 내부 통신을 위한 인가이다.

### ABAC(Atrribute-Based Access Control)
- 사용자 또는 그룹의 속성(Atrribute)에 따라 권한을 지정
- 정책은 JSON 파일로 정의하여 API 서버에 전달한다
- 예: "dev" 사용자는 Pod 생성, 조회, 삭제 가능
- 단점:
  - 사용자별 파일을 직접 관리해야 한다
  - 정책 변경 시 API 서버 재시작 필요
  - 확장성과 관리성이 떨어진다
- 현재는 거의 사용되지 않는다

### RBAC(Role-Based Access Control)
- 가장 널리 쓰이는 표준 인가 방식
- 사용자에게 직접 권한을 주는 대신:
  1. Role(역할)을 정의 -> 특정 권한 모음
  2. RoleBinding을 통해 사용자나 그룹을 Role에 연결
- 장점
  - 관리 효율적: Role만 수정하면 연결된 사용자 전부에 반영
  - 팀 단위, 환경 단위로 손쉽게 권한 관리 가능
- RBAC이 Kubernetes 보안 정책의 기본이 된다.

### Webhook Authorizer
- 인가를 외부 시스템에 위임할 수 있다
- 대표적으로 Open Policy Agent (OPA) 사용
  - API 서버가 사용자 정보와 요청을 OPA로 전달
  - OPA가 "허용/거부" 판단 후 응답
- 외부 중앙 정책 관리가 가능해 대규모 조직에 적합

### Authorization 모드 설정과 동작 순서
- kube-apiserver 실행 시 다음 옵션으로 설정
  ```
    --authorization-mode=Node, RBAC, Webhook
  ```
- 여러 모드를 콤마로 구분해 동시에 지정 가능
- 지정된 순서대로 실행
  1. Node Authorizer -> 노드 관련 요청만 허용, 나머지는 다음으로 전달
  2. RBAC -> 사용자 권한 검증 후 승인 시 종료
  3. Webhook -> 외부 시스템에 위임 (필요 시)
- 동작원리: 어떤 모드라도 요청을 승인하면 즉시 종료 -> 거부 시 다음 모드로 전달, 기본값은 AlwaysAllow